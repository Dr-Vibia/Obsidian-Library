### 二阶注入与普通注入的区别:

**普通SQL注入**：发生在一个 HTTP请求和响应中，对系统的攻击是立即执行的:

1. 攻击者在 http 请求中提交非法输入;
2. 应用程序处理非法输入，使用非法输入构造SQL语句;
3. 在攻击过程中向攻击者返回结果。  

**二阶SQL注入:**

1. 攻击者在 http请求中提交某种经过构思的输入;
2. 应用程序存储该恶意输入(通常保存在数据库中)以便后面使用并响应请求;
3. 攻击者提交第二次（不同的)http请求;
4. 为处理第二次http请求，程序会检索存储在数据库中的恶意输入并进行处理，从而导致攻击者构造的SQL查询被执行;
6. 如果攻击成功，在第二次请求响应中向攻击者返回查询结果。

### 利用过程

1、访问连接，输入用户名“Admin’”和密码“admin”，提交

![[Pasted image 20220920230229.png]]

2、可以看到,虽然用户名后面添加了一个单引号,但注册成功；说明可能有转义函数将单引号转义或者过滤了

![[Pasted image 20220920230250.png]]

3、此时点击“点击发布”，输入test提交

![[Pasted image 20220920230309.png]]

4、发现出现数据库错误信息，这个位置没有转义函数，可能存在SQL注入

![[Pasted image 20220920230337.png]]

5、再试一次，这次填入“'+substring(version(),1,50)+'”和“test”提交

![[Pasted image 20220920230406.png]]

6、可以看到注册成功，点击“点击发布”

![[Pasted image 20220920230421.png]]

7、输入test，提交

![[Pasted image 20220920230431.png]]

8、返回MySQL数据库版本信息，说明确实此处存在SQL注入漏洞

![[Pasted image 20220920230504.png]]

### 二阶注入原理

由于二阶注入理论性太强，这里简单描述一下。

二阶注入涉及到四个过程：SELECTàINSERTàSELECTàINSERT。

第一阶段是SELECTàINSERT，数据被放入数据库的时候，由于遇到addslashes等转义函数，将单引号（’、”）等特殊字符通过反斜杠（ \ ）进行转义后再放入数据库；但是addslashes函数不会将反斜杠引入数据库，所以插入数据库的数据还是原来输入的数据，也就是数据库语句。

第二阶段再次往数据库插入数据的同时需要引用第一次插入的数据，那么就得查询第一次输入的数据；在查询数据的时候，由于未对数据库中的数据进行检查和转义，导致第一次注入的数据库语句原封不动被提取出来；然而进行再次插入的时候也未对数据进行检查转义，直接导致第一次输入的数据库语句得到了拼接并成功执行，然后将结果保存在数据库中。

大体过程类似于以下原理图

![[Pasted image 20220920230659.png]]

