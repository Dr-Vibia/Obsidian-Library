\begin{tikzpicture}[font=\tiny,thin,
	fw/.style={inner sep=0pt, black,fill=white},
	rv/.style={red, very thick}]
\foreach \z in {1, 2,...,3} {
\node (km\z) at ($\z*(0,-2.2cm)$) [minimum width=6cm,rounded corners=1ex,draw] {$K_\z$};
\foreach \x in {1, 2,...,4} {
\node (s\z\x) at ($(km\z)+\x*(1.5cm,0)-(3.75cm,0.7cm)$) [minimum width=1.2cm,rounded corners=1ex,draw] {$S_{\z,\x}$};
}
\foreach \x in {1, 2,...,4} {
\foreach \y in {1, 2,...,4} {
\draw[-] ($(s\z\x.north)+\y*(0.3cm,0)-(0.75cm,0)$) -- +(0,0.22cm);
\draw[-] ($(s\z\x.south)+\y*(0.3cm,0)-(0.75cm,0)$) -- +(0,-0.22cm) -- ($(s\z\y.south)+\x*(0.3cm,0)-(0.75cm,0.8cm)$) -- +(0,-0.22cm);
}
}
}
\foreach \z in {4} {
\node (km\z) at ($\z*(0,-2.2cm)$) [minimum width=6cm,rounded corners=1ex,draw] {$K_\z$};
}
\foreach \x in {1, 2,...,4} {
\foreach \y in {1, 2,...,4} {
\draw[-] ($(s3\x.north)+\y*(0.3cm,0)-(0.75cm,2.2cm)$) -- +(0,0.22cm);
\draw[-] ($(s3\x.south)+\y*(0.3cm,0)-(0.75cm,-5.8cm)$) -- +(0,-0.22cm);
}
}
%\node at ($(s11.north)+1*(0.3cm,0)-(0.75cm,-5.4cm)$) {$P_1$};
%\node at ($(s14.north)+4*(0.3cm,0)-(0.75cm,-5.4cm)$) {$P_{16}$};
%\node at ($(s12.north)+(1.5cm,0)-(0.75cm,-5.4cm)$) {\textbf{Plaintext}};

\node (p5) at ($(s12.north)+1*(0.3cm,0)-(0.75cm,-0.8cm)$) [anchor=south, fw] {\small $p_5$};
\node (p7) at ($(s12.north)+3*(0.3cm,0)-(0.75cm,-0.8cm)$) [anchor=south, fw] {\small $p_7$};
\node (p8) at ($(s12.north)+4*(0.3cm,0)-(0.75cm,-0.8cm)$) [anchor=south, fw] {\small $p_8$};

\draw[rv,-] (p5) -- +(0,-1cm) node [pos=0.42, left,fw] {\small $k_{1,5}$} -- ($(s12.south)+2*(0.3cm,0)-(0.75cm,0)$);
\draw[rv,-] (p7) -- +(0,-1cm) node [pos=0.42, left,fw] {\small $k_{1,7}$} -- ($(s12.south)+2*(0.3cm,0)-(0.75cm,0)$);
\draw[rv,-] (p8) -- +(0,-1cm) node [pos=0.42, right,fw] {\small $k_{1,8}$} -- ($(s12.south)+2*(0.3cm,0)-(0.75cm,0)$);
\draw[rv,-latex] ($(s12.south)+2*(0.3cm,0)-(0.75cm,0)$) -- ($(s32.north)+2*(0.3cm,0)-(0.75cm,0)$) node [pos=0.32, left,fw] {\small $k_{2,6}$} node [pos=0.88, left,fw] {\small $k_{3,6}$} node [pos=1,left, fw] {\small $u_{3,6}$};
\draw[rv,-latex] ($(s22.north)+2*(0.3cm,0)-(0.75cm,0)$) -- ($(s22.south)+4*(0.3cm,0)-(0.75cm,0)$) -- +(0,-0.22cm) -- ($(s24.south)+2*(0.3cm,0)-(0.75cm,0.8cm)$) -- ($(s34.north)+2*(0.3cm,0)-(0.75cm,0)$) node [pos=0.5, left,fw] {\small $k_{3,14}$} node [pos=1,right, fw] {\small $u_{3,14}$};
\node (k41) at (1.5cm,-8.8cm) [fw] {\small $k_{4,2\cdot i}$};
\node (e1) at ($(km1)+5.6*(1.5cm,0)-(3.75cm,0.7cm)$) [fw] {\small $S_{1,2}$: $x_1 \oplus x_3 \oplus x_4 = y_2$};
\node (e2) at ($(km2)+5.4*(1.5cm,0)-(3.75cm,0.7cm)$) [fw] {\small $S_{2,2}$: $x_2 = y_2 \oplus y_4$};
\node (e3) at ($(km3)+5.5*(1.5cm,0)-(3.75cm,0.7cm)$) [fw] {\small $u_{3,6} \oplus u_{3,14} \oplus$};
\node (e4) at ($(km3)+5.5*(1.5cm,0)-(3.75cm,1.2cm)$) [fw] {\small $p_{5} \oplus p_{7} \oplus p_{8} = 0$};
\node (e5) [below of=e4,fw] {\small Guess $k_{4,2\cdot i}$};
\end{tikzpicture}